AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: "Single account cross-region DynamoDB Stream to S3 replication\n  \n"
Parameters:
  TargetS3Bucket:
    Type: String
    Description: Target S3 bucket name for storing DynamoDB changes
  TargetRegion:
    Type: String
    Default: us-west-2
    Description: The region for the target S3 bucket
  MaximumRecordAgeInSeconds:
    Type: String
    Default: '3600'
    Description: The maximum age (in seconds) of a record that Lambda sends to your
      function
  SourceTableStreamARN:
    Type: String
    Description: Source DynamoDB table stream ARN
  S3Prefix:
    Type: String
    Default: ddb-changes
    Description: S3 prefix for storing change files
Resources:
  StreamToS3Function:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: StreamToS3Function
      Handler: stream_to_s3_single_account.lambda_handler
      Runtime: python3.12
      Timeout: 900
      MemorySize: 512
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - dynamodb:DescribeStream
          - dynamodb:GetRecords
          - dynamodb:GetShardIterator
          - dynamodb:ListStreams
          Resource:
            Ref: SourceTableStreamARN
        - Effect: Allow
          Action:
          - s3:PutObject
          - s3:PutObjectAcl
          Resource:
            Fn::Sub: arn:aws:s3:::${TargetS3Bucket}/*
        - Effect: Allow
          Action:
          - logs:CreateLogGroup
          - logs:CreateLogStream
          - logs:PutLogEvents
          Resource: '*'
      Environment:
        Variables:
          TARGET_S3_BUCKET:
            Ref: TargetS3Bucket
          TARGET_REGION:
            Ref: TargetRegion
          S3_PREFIX:
            Ref: S3Prefix
      Events:
        DDBStreamEvent:
          Type: DynamoDB
          Properties:
            Stream:
              Ref: SourceTableStreamARN
            StartingPosition: TRIM_HORIZON
            BatchSize: 1000
            MaximumBatchingWindowInSeconds: 60
            MaximumRecordAgeInSeconds:
              Ref: MaximumRecordAgeInSeconds
    Metadata:
      SamResourceId: StreamToS3Function
Outputs:
  StreamToS3Function:
    Description: Lambda Function ARN
    Value:
      Fn::GetAtt:
      - StreamToS3Function
      - Arn
  StreamToS3FunctionIamRole:
    Description: Implicit IAM Role created for function
    Value:
      Fn::GetAtt:
      - StreamToS3FunctionRole
      - Arn
